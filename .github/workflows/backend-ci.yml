name: Backend CI

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'backend/**'
  push:
    branches: [main, master]
    paths:
      - 'backend/**'

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Python syntax
        working-directory: ./backend
        run: |
          python -m py_compile main.py
          python -m py_compile config.py
      
      - name: Run linting (optional)
        working-directory: ./backend
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true
      
      - name: Check imports
        working-directory: ./backend
        run: |
          python -c "import main; print('✅ Main module imports successfully')"
      
      - name: Environment variables check
        working-directory: ./backend
        run: |
          echo "✅ Checking for .env.railway.template"
          test -f .env.railway.template && echo "Template found" || echo "⚠️ Template not found"

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Railway configuration
        working-directory: ./backend
        run: |
          echo "Checking Railway configuration files..."
          test -f Procfile && echo "✅ Procfile" || echo "❌ Procfile missing"
          test -f railway.json && echo "✅ railway.json" || echo "❌ railway.json missing"
          test -f nixpacks.toml && echo "✅ nixpacks.toml" || echo "❌ nixpacks.toml missing"
          test -f runtime.txt && echo "✅ runtime.txt" || echo "❌ runtime.txt missing"
          test -f start.sh && echo "✅ start.sh" || echo "❌ start.sh missing"
          test -f requirements.txt && echo "✅ requirements.txt" || echo "❌ requirements.txt missing"
      
      - name: Check start.sh is executable
        working-directory: ./backend
        run: |
          if [ -x start.sh ]; then
            echo "✅ start.sh is executable"
          else
            echo "⚠️ start.sh is not executable"
            chmod +x start.sh
          fi
